# PC Agent (MVP)

Локальный агент-оператор ПК для Windows 10/11 на Python 3.10+. Агент принимает запрос, сначала пытается найти команду в библиотеке базовых команд, затем выполняет execute → verify → report. Если подходящей команды нет — используется LLM fallback для одного безопасного скрипта.

## LM Studio
1. Запустите LM Studio и включите локальный сервер (OpenAI-compatible) на `http://localhost:1234`.
2. Включите опцию **on-demand model loading** — агент использует модель FAST по имени.
3. Убедитесь, что сервер отвечает.

## Выбор моделей
Можно указать переменные окружения:

```bash
set FAST_MODEL=qwen2.5-3b-instruct
```

Если FAST_MODEL не задан, будет использована уже запущенная модель на сервере.
FAST используется для генерации ответов и fallback-сценариев, когда нет готовой команды.

## Установка зависимостей

```bash
python -m venv .venv
.venv\Scripts\activate
pip install -r requirements.txt
```

> ⚠️ **Python 3.13 пока не поддерживается большинством аудио-библиотек (torch/torchaudio).**
> Если вы видите ошибки вроде `AttributeError: module 'torchaudio' has no attribute 'list_audio_backends'`,
> используйте Python 3.10–3.12 и установите совместимые версии `torch`/`torchaudio`.

## Запуск

```bash
python app.py
```

## DEBUG логирование

Чтобы включить подробные DEBUG логи в консоль и файл `logs/pc_agent.log`, установите переменную окружения `PC_AGENT_DEBUG=1` или выполните `/debug` в CLI:

```bash
PC_AGENT_DEBUG=1 python app.py
```

В режиме DEBUG логируются события активного окна: `[WIN_BEFORE]`, `[WIN_FOCUS]`, `[WIN_CLICK]`, `[WIN_KEY]`, `[WIN_VERIFY]`, а также итоговое состояние `[ACTIVE_WINDOW]`.

## Voice control

Установите зависимости голосового ввода:

```bash
pip install vosk sounddevice numpy
```

Если используете Whisper/VAD и появляется ошибка `torchaudio`:

1. Установите Python 3.10–3.12 (не 3.13).
2. Переустановите `torch` и `torchaudio` под вашу версию Python и CUDA, используя
   инструкции на https://pytorch.org/get-started/locally/.
3. Проверьте установку:

```bash
python - <<'PY'
import torch, torchaudio
print(torch.__version__)
print(torchaudio.__version__)
print(hasattr(torchaudio, "list_audio_backends"))
PY
```

Для Whisper дополнительно:

```bash
pip install openai-whisper
```

Скачайте русскую модель Vosk:

```bash
python scripts/download_vosk_ru.py
```

Запуск в голосовом режиме:

```bash
VOICE=1 python app.py
```

Либо включите в рантайме командой `/voice` (и отключите `/voice off`).

### Как пользоваться voice-mode
1. В голосовом режиме нажмите Enter — агент начнет слушать одну фразу.
2. После распознавания фразы команда выполнится.
3. Скажите "стоп" или "выключи голос", чтобы выйти из voice-mode.

### Как улучшить качество распознавания
- Используйте полноразмерную модель Vosk (например `vosk-model-ru-0.22`) — она точнее, но тяжелее.
- Малая модель (`vosk-model-small-ru-0.22`) быстрее, но чаще ошибается на шуме.
- Чтобы переключить размер, задайте `VOSK_MODEL_SIZE=full|small` или `VOSK_MODEL_DIR` для своего пути.
- Убедитесь, что в комнате тихо и микрофон настроен на 16 kHz.

### Переключение движка распознавания
- По умолчанию используется Vosk.
- Для Whisper задайте `VOICE_ENGINE=whisper` и `WHISPER_MODEL_SIZE=small|full` (full = base).
- Для Vosk задайте `VOICE_ENGINE=vosk` и `VOSK_MODEL_SIZE=small|full`.
- Можно сменить в рантайме: `/voice models` и `/voice model <engine> <size>`.

## Архитектура
- **Command Library**: набор базовых команд с execute/verify (`core/command_library.yaml`, ключ `commands`).
- **Command Engine**: матчинг запросов по ключевым словам/паттернам, подстановка параметров и запуск команд.
- **LLM fallback**: если подходящей команды нет — LLM генерирует один безопасный скрипт (Python или PowerShell).
- **Reporter**: краткий итог пользователю без code blocks.

Ответ всегда включает строку `COMMAND: ...` или `SCRIPT[...]`, чтобы было видно, что именно пытается выполнить агент.

## Память активного файла
Агент запоминает последний созданный/изменённый файл и применяет короткие команды к нему автоматически.

Пример сценария:
1. "создай docx"
2. "измени шрифт на Times New Roman"
3. "добавь текст в документ"

Если активный файл не задан, агент спросит уточнение.

## YouTube control
Примеры команд:
- "поставь на паузу"
- "перемотай вперед 1 минуту"
- "назад 10 секунд"
- "выключи звук"
- "громче"
- "на весь экран"

Поддерживаемые действия: play/pause, перемотка, mute/unmute, громкость, fullscreen.
Ограничения: управление идет через фокус активного окна браузера и горячие клавиши YouTube (без открытия новых вкладок).

## Notepad
Примеры команд:
- "открой блокнот"
- "напиши в этом блокноте привет"
- "закрой блокнот"

## Active Window Control
Агент сохраняет активное окно после каждого шага (заголовок, процесс, PID, HWND) в `state.json`. Эти данные используются для безопасного управления UI.

Примеры команд:
- "какое активное окно"
- "сфокусируй окно YouTube"
- "сфокусируй процесс chrome.exe"
- "кликни в центр"
- "в адресную строку введи github.com и открой"
- "найди в гугле коты мемы"
- "закрой вкладку"

## Примеры запросов
1. "Открой блокнот"
2. "Открой Яндекс Музыку"
3. "Открой сайт https://music.yandex.ru"
4. "Выполни powershell команду для списка процессов"
5. "создай txt на рабочем столе и заполни 27 строк"
6. "создай docx с эссе"
7. "открой блокнот"

## Логи
Все запросы, подтверждения и результаты инструментов пишутся в `logs/session_*.jsonl`.

## Поиск приложений
При первом запуске CLI попросит указать папки, где искать установленные программы (например, `C:\Program Files`). Эти пути сохраняются в `app_search_paths.json`.

## Команды CLI
- `/help` — показать справку
- `/exit` — выход
- `/reset` — сбросить контекст
- `/debug` — включить/выключить подробные логи
- `/screens` — список последних скриншотов
- `/active` — показать активные file/url/app
- `/files` — список последних файлов
- `/urls` — список последних URL
- `/apps` — список последних приложений
- `/use <номер|путь>` — выбрать активный файл
- `/clear` — очистить состояние памяти

## Безопасность
Подтверждения команд отключены. Вместо этого действует строгий SafeValidator: опасные операции блокируются автоматически. Примеры запретов:
- Удаление файлов/папок, форматирование дисков, управление службами, реестром, выключение/перезагрузка.
- Любые действия в системных каталогах (`C:\\Windows`, `C:\\Program Files`, `C:\\ProgramData`, `AppData`).
- Скачивание и запуск `.exe` из интернета.
- Запись за пределами Desktop/Documents/Downloads/%TEMP%.

Разрешённые безопасные области записи: Desktop, Documents, Downloads, `%TEMP%`.
